<!DOCTYPE html>
<html>
<style>
.line {
	fill: none;
	stroke-width: 2px;
	stroke: #008B00;
}
</style>
<script src='https://d3js.org/d3.v5.min.js'></script>
<head>
	<title id='pageTitle'></title>
</head>
<body onload = 'init()'>
	<h1 id='heading1'></h1>
	<div class = 'navigation'>
		<button class='nav_back' onclick="window.location.href = 'index.html';">Return to overview of all stocks</button>
	</div>
	<div class = 'overview' style="text-align: center;">
		<h1 id='overviewHeading'></h1>
		<svg width=1200 height=1000>
		</svg>
	</div>

	<div class = 'holdings' style="text-align: center;">
		<h1 id='holdingsHeading'></h1>
		<text text-anchor='middle' x="400" y='400'> Test</text>
	</div>
	<div style="display: none">
		<form id=stock_detail action="stock_detail.html" method="GET">
			<input type="" name="stock" id='stock_name'>
			<button type = 'submit'></button>
		</form>
	</div>
	<div class = 'sectors' style="text-align: center;">
		<h1 id='sectorsHeading'></h1>
	</div>

	<div class = 'countries' style="text-align: center;">
		<h1 id='counteriesHeading'></h1>
	</div>


	<div id='holdingsTooltip'></div>
	<script>

		var margin = {
			top: 100,
			bottom: 100,
			left: 100,
			right: 100
		};
		var width = d3.select('.overview').select('svg').attr('width') - margin.left - margin.right;
		var height = d3.select('.overview').select('svg').attr('height') - margin.top - margin.bottom;

		var color = ['pink', 'lightcyan', '#f8b70a','lightblue','#6149c6','lightgreen', '#9f8170', 'lightyellow', '#8ABD4A',  'violet'];
		var priceTooltip = d3.select('body').append('div').style('position','absolute').style("opacity", 0);
		function getQueryVariable(variable)
		{
			var query = window.location.search.substring(1);
			var vars = query.split('&');
			for (var i=0;i<vars.length;i++) {
				var pair = vars[i].split('=');
				if (pair[0] == variable)
				{
					return pair[1];
				}
			}
		}
		async function init() {
			if (window.location.href.includes('?')) {
				etf = getQueryVariable('etf');
			}
			else {
				etf = 'QQQ';
			}

			const dataPrices = await d3.csv("Data/" + etf + '_PRICES.csv');
			const dataHoldings = await d3.csv("Data/" + etf + 'Holdings.csv');
			const dataSectors = await d3.csv("Data/" + etf + 'Sectors.csv');
			const dataCountries = await d3.csv("Data/" + etf + 'Countries.csv');
			document.getElementById("pageTitle").innerHTML = etf + " Details";
			//document.getElementById("heading1").innerHTML = etf + " Details";
			document.getElementById('overviewHeading').innerHTML = etf + ' Overview';
			document.getElementById('holdingsHeading').innerHTML = etf + ' Top 10 Holdings';
			document.getElementById('sectorsHeading').innerHTML = etf + ' Top 10 Sectors';
			document.getElementById('counteriesHeading').innerHTML = etf+' Top 10 Countries';


			var pie = d3.pie().value(function(d) {return d.PercentOfFund;});
			var arc = d3.arc().innerRadius(150).outerRadius(300);
			var holdingsPie = d3.select('.holdings').append('svg').attr('height', 800).attr('width', 800).append('g').attr('transform', 'translate(400,400)').selectAll('path').data(pie(dataHoldings)).enter().append('path').attr('d', arc).attr('fill', function(d, i){return color[i];});

			var sectorsPie = d3.select('.sectors').append('svg').attr('height', 800).attr('width', 800).append('g').attr('transform', 'translate(400,400)').selectAll('path').data(pie(dataSectors)).enter().append('path').attr('d', arc).attr('fill', function(d, i){return color[i];});

			var countriesPie = d3.select('.countries').append('svg').attr('height', 800).attr('width', 800).append('g').attr('transform', 'translate(400,400)').selectAll('path').data(pie(dataCountries)).enter().append('path').attr('d',arc).attr('fill', function(d,i){return color[i];});

			holdingsPie.on('click', function(d){
				document.getElementById('stock_name').value=d.data.Ticker;
			    document.getElementById('stock_detail').submit();
			});
			holdingsPie.on("mouseover", function(d,i) {
				d3.select(this).attr("class", 'pie_highlight');
				d3.select('#holdingsTooltip')
				.style('opacity',1)
				.style('left', (d3.event.pageX) + 'px')
				.style('top', (d3.event.pageY-30) +'px')
				.html(d.data.Ticker + ': ' + d.data.PercentOfFund + "%");

				console.log(d.data.Ticker + ': ' + d.data.PercentOfFund+ "%");
			});
			holdingsPie.on("mousemove", function(){
				d3.select('#holdingsTooltip')
				.style('left', (d3.event.pageX) + 'px')
				.style('top', (d3.event.pageY-30) +'px');
			});

			holdingsPie.on('mouseout', function(){
				d3.select(this).attr('class', 'pie');
				d3.select('#holdingsTooltip')
				.style('opacity',0);
			});

//Overview
			dates = dataPrices.map(function(d) {
				return new Date(d.Date); });

			closes = dataPrices.map(function(d) {
				return parseFloat(d.Close); });

			var timeMin = Math.min.apply(null, dates);
			var timeMax = Math.max.apply(null, dates);
			var xScale = d3.scaleTime().domain([timeMin, timeMax]).range([0, width]);

			var priceMin = Math.min.apply(null, closes);
			var priceMax = Math.max.apply(null, closes);

			var yScale = d3.scaleLinear().domain([priceMin, priceMax]).range([height, 0]);
			var xAxis = d3.axisBottom(xScale);

			d3.select('.overview').select('svg').append("g")
				.attr("class", 'xAxis')
	   			.attr("transform", "translate("+ margin.left +", " + (margin.top + height) +")")
  	   			.style("font", "14px times")
  	   			.call(xAxis);

  	   		var yAxis = d3.axisLeft(yScale);

			d3.select('.overview').select('svg').append("g")
				.attr('class', 'yAxis')
  	   			.attr("transform", "translate("+ margin.left + ", "+ margin.top + ")")
  	   			.style("font", "14px times")
	   			.call(yAxis);
			var line = d3.line()
        	 .x(function(d) {return xScale(new Date(d.Date));})
        	 .y(function(d) {return yScale(parseFloat(d.Close)); });

  			var stockline=d3.select('.overview').select('svg').append('g')
               			.attr("transform", "translate("+margin.left+", "+margin.top+")")
         	   			.append("path")
         	   			.data([dataPrices])
         	   			.attr("d", line)
         	   			.attr('id', etf+'line')
       		  			.attr("class", "line");


			stockline.on("mouseover", function(d,i){
				console.log(d);
				console.log(i);
				console.log(d[i]);
				d3.select(this).attr('fill','DarkSlateGrey');
				priceTooltip.style("opacity", 1)
				priceTooltip.html(
					"<p><strong>" + etf + ', ' + d[i].Date + '</strong></p><br>' +
					"<p><strong>" + 'Open: ' + d[i].Open + '</strong></p><br>' +
					"<p><strong>" + 'CLose: ' + d[i].Close + '</strong></p><br>' +
					"<p><strong>" + 'High: ' + d[i].High + '</strong></p><br>' +
					"<p><strong>" + 'Low: ' + d[i].Low + '</strong></p><br>' +	
					"<p><strong>" + 'Volume: ' + d[i].Volume + '</strong></p><br>');

			});
			stockline.on("mousemove", function(){
				priceTooltip.style("top", (event.pageY-10)+"px").style("left",(event.pageX+10)+"px");
			});
			stockline.on("mouseout", function(){
				priceTooltip.style("opacity", 0);
			});
}
	</script>
</body>
</html>