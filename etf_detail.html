<!DOCTYPE html>
<html>
<style>
.line {
	fill: none;
	stroke-width: 2px;
	stroke: BlueViolet;
}
</style>
<script src='https://d3js.org/d3.v5.min.js'></script>
<head>
	<title id='pageTitle'></title>
</head>
<body onload = 'init()'>
	<h1 id='heading1'></h1>
	<div class = 'overview'>
		<h2 id='overviewHeading'></h2>
	</div>

	<div class = 'holdings'>
		<h2 id='holdingsHeading'></h2>
	</div>
	<div style="display: none">
		<form id=stock_detail action="stock_detail.html" method="GET">
			<input type="" name="stock" id='stock_name'>
			<button type = 'submit'></button>
		</form>
	</div>
	<div class = 'sectors'>
		<h2 id='sectorsHeading'></h2>
	</div>

	<div class = 'countries'>
		<h2 id='counteriesHeading'></h2>
	</div>


	<script>

		var margin = {
			top: 50,
			bottom: 50,
			left: 100,
			right: 0
		};
		var width = 1200 - margin.left - margin.right;
		var height = 1000 - margin.top - margin.bottom;

		var xScale = calculateXScale();
		var yScale = calculateYScale();
		var xAxis = plotXAxis(xScale);
		var yAxis = plotYAxis(yScale);			

		function calculateXScale(){
			var timeMin = new Date('07/19/2010');
			var timeMax = new Date('07/17/2020');
			var xScale = d3.scaleTime().domain([timeMin, timeMax]).range([0, width]);
			return xScale;
		}

		function calculateYScale(){
			var priceMin = 0;
			var priceMax = 800000;

			var yScale = d3.scaleLinear().domain([priceMin, priceMax]).range([height, 0]);
			return yScale;
		}

		function plotXAxis(xScale){
			var xAxis = d3.axisBottom(xScale);

			svg.append("g")
				.attr("class", 'xAxis')
	   			.attr("transform", "translate("+ margin.left +", " + (margin.top + height) +")")
  	   			.style("font", "14px times")
  	   			.call(xAxis);
  	   		return xAxis;
		}
		function plotYAxis(yScale){
       		var yAxis = d3.axisLeft(yScale);

			svg.append("g")
				.attr('class', 'yAxis')
  	   			.attr("transform", "translate("+ margin.left + ", "+ margin.top + ")")
  	   			.style("font", "14px times")
	   			.call(yAxis);
		   	return yAxis;
		}
		function getQueryVariable(variable)
		{
			var query = window.location.search.substring(1);
			var vars = query.split('&');
			for (var i=0;i<vars.length;i++) {
				var pair = vars[i].split('=');
				if (pair[0] == variable)
				{
					return pair[1];
				}
			}
		}
		async function init() {
			if (window.location.href.includes('?')) {
				etf = getQueryVariable('etf');
			}
			else {
				etf = 'QQQ';
			}

			const dataPrice = await d3.csv("Data/" + etf + '_PRICES.csv');
			const dataHoldings = await d3.csv("Data/" + etf + 'Holdings.csv');
			const dataSectors = await d3.csv("Data/" + etf + 'Sectors.csv');
			const dataCountries = await d3.csv("Data/" + etf + 'Countries.csv');
			document.getElementById("pageTitle").innerHTML = etf + " Details";
			document.getElementById("heading1").innerHTML = etf + " Details";
			document.getElementById('overviewHeading').innerHTML = etf + ' Overview:';
			document.getElementById('holdingsHeading').innerHTML = etf + ' Top 10 Holdings:';
			document.getElementById('sectorsHeading').innerHTML = etf + ' Top 10 Sectors:';
			document.getElementById('counteriesHeading').innerHTML = etf+'Top 10 Countries';
			var color = ['pink', 'lightcyan', '#f8b70a','lightblue','#6149c6','lightgreen', '#9f8170', 'lightyellow', '#8ABD4A',  'violet'];


			var pie = d3.pie().value(function(d) {return d.PercentOfFund;});
			var arc = d3.arc().innerRadius(150).outerRadius(300);
			var stockPie = d3.select('.holdings').append('svg').attr('height', 800).attr('width', 800).append('g').attr('transform', 'translate(400,400)').selectAll('path').data(pie(dataHoldings)).enter().append('path').attr('d', arc).attr('fill', function(d, i){return color[i];});

			d3.select('.sectors').append('svg').attr('height', 800).attr('width', 800).append('g').attr('transform', 'translate(400,400)').selectAll('path').data(pie(dataSectors)).enter().append('path').attr('d', arc).attr('fill', function(d, i){return color[i];});

			d3.select('.countries').append('svg').attr('height', 800).attr('width', 800).append('g').attr('transform', 'translate(400,400)').selectAll('path').data(pie(dataCountries)).enter().append('path').attr('d',arc).attr('fill', function(d,i){return color[i];});

			stockPie.on('click', function(d){
				document.getElementById('stock_name').value=d.data.Ticker;
			    document.getElementById('stock_detail').submit();
			});

			dates = dataPrice.map(function(d) {
				return new Date(d.Date); });

			closes = dataPrice.map(function(d) {
				return parseFloat(d.Close); });

			var line = d3.line()
        	 .x(function(d) {return xScale(new Date(d.Date));})
        	 .y(function(d) {return yScale(parseFloat(d.Close)/parseFloat(closes[closes.length - 1])*10000); });

  			var stockline=d3.select('.overview').append('svg').attr('height', 1200).attr('width', 1000).append('g')
               			.attr("transform", "translate("+margin.left+", "+margin.top+")")
         	   			.append("path")
         	   			.data([dataPrice])
         	   			.attr("d", line)
         	   			.attr('id', etf+'line')
       		  			.attr("class", "line")
}
	</script>
</body>
</html>