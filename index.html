<!DOCTYPE html>
<html>
<style>
.line {
	fill: none;
	stroke-width: 1px;
}
</style>
<!-- load the d3.js library -->   
<script src='https://d3js.org/d3.v5.min.js'></script>
<head>]
	<title> Stock Historical Data over Time</title>
</head>
<body onload="init()">
	<h1>Growth of $10,000 as of July 17,2020</h1>
	<svg width=1200 height=1000>
	</svg>
	<div id='checkboxContainer'></div>
	<script>
		async function init() {
			const stockList = await d3.csv('Data/StockList.csv');


			stockList.forEach(function(stockId, index){
				var ticker = stockId.Ticker;
				var company = stockId.Company;

				var checkbox = document.createElement('input');
				checkbox.type = 'checkbox';
				checkbox.id = ticker;
				checkbox.name = 'showStock';
				checkbox.value = ticker;
				checkbox.checked = true;
				checkbox.onclick = "updateStockList()";

				var label = document.createElement('label');
				label.htmlFor = ticker;
				label.appendChild(document.createTextNode(company));

				var br = document.createElement('br');

				var container = document.getElementById('checkboxContainer');
				container.appendChild(checkbox);
				container.appendChild(label);
				container.appendChild(br);

			});

			var svg = d3.select("svg");
			plotStockList(svg, stockList);            	

			function plotStockList(svg, stockList) {
				d3.selectAll("path").remove();

				console.log(stockList);
				var timeMin = new Date('07/19/2010');
				var timeMax = new Date('07/17/2020');
				var priceMin = 0;

				var priceMax = 10000;
				for (i = 0; i < stockList.length; i++){
					const data = await d3.csv('Data/' + stockList[i].Ticker + '.csv')
					
					var prices = data.map(function(d) {
							return parseFloat(d.Close); });
					var maxofStock = Math.max.apply(null, prices);
					var minofStock = Math.min.apply(null, prices);
					console.log(maxofStock);
					priceMax = Math.max(priceMax, maxofStock/minofStock * 10000);
					console.log(priceMax);

				}

				var width = 1000;
				var height = 900;
				console.log(priceMax);
            	var xScale = d3.scaleTime().domain([timeMin, timeMax]).range([0, width]);
				var yScale = d3.scaleLinear().domain([priceMin, priceMax]).range([height, 0]);

            	var xAxis = d3.axisBottom(xScale);
            	var yAxis = d3.axisLeft(yScale);

				svg.append("g")
			  	   	.attr("transform", "translate(100, 50)")
			  	   	.style("font", "14px times")
			  	   	.call(yAxis);

				svg.append("g")
			 	   	.attr("transform", "translate(100, 950)")
			  	   	.style("font", "14px times")
			  	   	.call(xAxis);

            	var colors = ['DarkOrange','SkyBlue','Crimson','LawnGreen', 'magenta', 'BlueViolet', 'BurlyWood', 'Brown', 'DarkGreen', 'DarkSlateGrey','IndianRed','LawnGreen','LightSalmon'];

				stockList.forEach(function(stockId, index){
					var ticker = stockId.Ticker;
					var company = stockId.Company;

					const data = d3.csv('Data/' + ticker + '.csv')
					.then(function(data){

						dates = data.map(function(d) {
							return new Date(d.Date); });

						closes = data.map(function(d) {
							return parseFloat(d.Close); });


						var line = d3.line()
					            	 .x(function(d) {return xScale(new Date(d.Date));})
					            	 .y(function(d) {return yScale(parseFloat(d.Close)/parseFloat(closes[closes.length - 1])*10000); });

			  			svg.append('g')
			               .attr("transform", "translate(100, 50)")
			         	   .append("path")
			         	   .data([data])
			         	   .attr("d", line)
			       		   .attr("class", "line")
			          	   .attr("stroke", colors[index]);
					})
					.catch(function(){
						console.log("error loading file");

					});


				});

			}

			stockList.forEach(function(stockId,index) {
				var ticker = stockId.Ticker;
				document.getElementById(ticker).onclick = function(){
					if (document.getElementById(ticker).checked)
					{
						stockList.push(stockId);
					}
					else
					{
						var pos = stockList.indexOf(stockId);
						stockList.splice(pos,1);
					}
					plotStockList(svg, stockList);

				}
			});

		}
	</script>
</body>
</html>
