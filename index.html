<!DOCTYPE html>
<html>
<head>
	<!-- load the d3.js library -->   
	<script src='https://d3js.org/d3.v5.min.js'></script>
	<link rel='stylesheet' href='style.css'>
	<title> Stock Historical Data over Time</title>
</head>
<body onload="init()">
	<div class = 'overview' style = 'text-align: center;'>
		<h1>Growth of $10,000 as of July 17,2020</h1>
		<svg width=1000 height=800>
		</svg>
	</div>

	<div id='checkboxContainer'></div>
	<div id='lineTooltip'></div>
	<div style = 'display:none'>
		<form id='etf_detail' action = 'etf_detail.html' method="GET">
			<input id="etf_name" name="etf" value=''><br>
			<button type='submit'></button>
		</form>
	</div>
	<div style="display: none">
		<form id='stock_detail' action ='stock_detail.html' method="GET">
			<input id='stock_name' name='stock' value=""><br>
			<button type="submit"></button>
		</form>
	</div>
	<script>
		var margin = {
			top: 100,
			bottom: 100,
			left: 100,
			right: 100
		};

		var width = d3.select('.overview').select("svg").attr('width') - margin.left - margin.right;
		var height = d3.select('.overview').select("svg").attr('height') - margin.top - margin.bottom;

		var colors = ['DarkOrange','SkyBlue','Crimson','LawnGreen', 'magenta', 'BlueViolet', 'BurlyWood', 'Brown', 'DarkGreen', 'DarkSlateGrey','IndianRed','LawnGreen','LightSalmon'];

		var colors_try = {
			FB: 'Brown',
			AMZN: 'DarkGreen',
			AAPL: 'DarkOrange',
			GOOG: 'magenta',
			GOOGL: 'IndianRed',
			MSFT: 'DarkSlateGrey',
			TSLA: 'BlueViolet',
			QQQ: 'BurlyWood',
			SPY: 'LawnGreen'
		};
		async function init() {
			const stockList = await d3.csv('Data/StockList.csv');


			stockList.forEach(function(stockId, index){
				var ticker = stockId.Ticker;
				var company = stockId.Company;

				var checkbox = document.createElement('input');
				checkbox.type = 'checkbox';
				checkbox.id = ticker;
				checkbox.name = 'showStock';
				checkbox.value = ticker;
				checkbox.checked = true;
				checkbox.onclick = "updateStockList()";

				var label = document.createElement('label');
				label.htmlFor = ticker;
				label.appendChild(document.createTextNode(company));

				var br = document.createElement('br');

				var container = document.getElementById('checkboxContainer');
				container.appendChild(checkbox);
				container.appendChild(label);
				container.appendChild(br);

			});



			var xScale = calculateXScale();
			var yScale = calculateYScale(stockList);
			var xAxis = plotXAxis(xScale);
			var yAxis = plotYAxis(yScale);			
			plotStockList(xScale, yScale, stockList);            	

			function calculateXScale(){
				var timeMin = new Date('07/19/2010');
				var timeMax = new Date('07/17/2020');
				var xScale = d3.scaleTime().domain([timeMin, timeMax]).range([0, width]);
				return xScale;
			}

			function calculateYScale(stockList){
				var priceMin = 0;
				var priceMax = 800000;

				var yScale = d3.scaleLinear().domain([priceMin, priceMax]).range([height, 0]);
				return yScale;
			}

			function plotXAxis(xScale){
				var xAxis = d3.axisBottom(xScale);

				d3.select('.overview').select("svg").append("g")
					.attr("class", 'xAxis')
		   			.attr("transform", "translate("+ margin.left +", " + (margin.top + height) +")")
	  	   			.style("font", "14px times")
	  	   			.call(xAxis);

	  	   		d3.select('.overview').select("svg").append("g").append('text')
					.attr("class", 'x label')
					.attr('text-anchor', 'end')
		   			.attr("transform", "translate("+ margin.left +", " + (margin.top + height) +")")
		   			.attr('x', width/2)
		   			.attr('y', height/10)
		   			.text('Year');
	  	   		return xAxis;
			}
			function plotYAxis(yScale){
           		var yAxis = d3.axisLeft(yScale);

				d3.select('.overview').select("svg").append("g")
					.attr('class', 'yAxis')
	  	   			.attr("transform", "translate("+ margin.left + ", "+ margin.top + ")")
	  	   			.style("font", "14px times")
		   			.call(yAxis);

				d3.select('.overview').select("svg").append("g").append('text')
					.attr('class', 'y label')
					.attr('text-anchor', 'middle')
	  	   			.attr("transform", "translate("+ margin.left + ", "+ margin.top + ")")
		   			.attr('x', -height/2)
		   			.attr('y', -margin.left)
		   			.attr('transform','rotate(-90)')
		   			.text('Value($)');		
		   		return yAxis;
			}

			function plotStockList(xScale, yScale, stockList) {
			//	d3.selectAll("path").remove();

				stockList.forEach(function(stockId, index){
					var ticker = stockId.Ticker;
					var company = stockId.Company;

					const data = d3.csv('Data/' + ticker + '_PRICES.csv')
					.then(function(data){

						dates = data.map(function(d) {
							return new Date(d.Date); });

						closes = data.map(function(d) {
							return parseFloat(d.Close); });


						var priceBase = Math.min(parseFloat(closes[closes.length - 1]), parseFloat(closes[0]));
						var line = d3.line()
					            	 .x(function(d) {return xScale(new Date(d.Date));})
					            	 .y(function(d) {return yScale(parseFloat(d.Close)/priceBase*10000); });

			  			var stockline=d3.select('.overview').select("svg").append('g')
			               			.attr("transform", "translate("+margin.left+", "+margin.top+")")
			         	   			.append("path")
			         	   			.data([data])
			         	   			.attr("d", line)
			         	   			.attr('id', ticker+'line')
			       		  			.attr("class", "line")
			          	   			.attr("stroke", colors_try[ticker]);

			          	stockline.on('click', function(){
			          		if (ticker=="QQQ" || ticker=="SPY" || ticker =="EWH")
			          		{
			          			document.getElementById('etf_name').value=ticker;
			          			document.getElementById("etf_detail").submit();
			          		}
			          		else
			          		{
			          			document.getElementById('stock_name').value=ticker;
			          			document.getElementById('stock_detail').submit();
			          		}

			          	});


						stockline.on("mouseover", function(d,i){

							var pointer = d3.mouse(this);
							index = Math.round(pointer[0] * (d.length-1)/width);
							if (ticker != 'MSFT')
							{
								index = d.length-1-index;
							}

							if (ticker == 'GOOG' || ticker =='FB')
							{
								index = Math.round(2518*(width-pointer[0])/width);
							}

							if (index < 0)
							{
								index = 0;
							}
							if (index > d.length - 1)
							{
								index = d.length - 1;
							}
							d3.select('#lineTooltip').style("opacity", 1).style("top", (event.pageY-10)+"px").style("left",(event.pageX+10)+"px")
							.html("<p><strong>" + ticker + ', ' + d[index].Date + '</strong></p><br>' +
							"<p><strong>" + 'Open: ' + d[index].Open + '</strong></p><br>' +
							"<p><strong>" + 'CLose: ' + d[index].Close + '</strong></p><br>' +
							"<p><strong>" + 'High: ' + d[index].High + '</strong></p><br>' +
							"<p><strong>" + 'Low: ' + d[index].Low + '</strong></p><br>' +	
							"<p><strong>" + 'Volume: ' + d[index].Volume + '</strong></p><br>');

						});
						stockline.on("mousemove", function(){
							d3.select('#lineTooltip').style("top", (event.pageY-10)+"px").style("left",(event.pageX+10)+"px");
						});
						stockline.on("mouseout", function(){
							d3.select('#lineTooltip').style("opacity", 0);
						});


					})
					.catch(function(){
						console.log("error loading file");

					});


				});

			}


			stockList.forEach(function(stockId,index) {
				var ticker = stockId.Ticker;
				document.getElementById(ticker).onclick = function(){
					if (document.getElementById(ticker).checked)
					{
						stockList.push(stockId);
						plotStockList(xScale, yScale, stockList);  

					}
					else
					{
						var pos = stockList.indexOf(stockId);
						stockList.splice(pos,1);
						d3.selectAll('#'+ticker + 'line').remove();
					}
					//d3.selectAll("path.line").remove();
					//var yScale = calculateYScale(stockList);
					//updateYAxis(yScale);
					//plotXAxis(xScale);
				//	plotYAxis(yScale);

				}
			});

		}
	</script>
</body>
</html>
