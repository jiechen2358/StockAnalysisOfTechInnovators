<!DOCTYPE html>
<html>
<style>
.line {
	fill: none;
	stroke-width: 1px;
}
</style>
<!-- load the d3.js library -->   
<script src='https://d3js.org/d3.v5.min.js'></script>
<head>

	<title> Stock Historical Data over Time</title>
</head>
<body onload="init()">
	<h1>Growth of $10,000 as of July 17,2020</h1>
	<svg width=1200 height=1000>
	</svg>
	<div id='checkboxContainer'></div>
	<script>
		async function init() {
			const stockList = await d3.csv('Data/StockList.csv');


			stockList.forEach(function(stockId, index){
				var ticker = stockId.Ticker;
				var company = stockId.Company;

				var checkbox = document.createElement('input');
				checkbox.type = 'checkbox';
				checkbox.id = ticker;
				checkbox.name = 'showStock';
				checkbox.value = ticker;
				checkbox.checked = true;
				checkbox.onclick = "updateStockList()";

				var label = document.createElement('label');
				label.htmlFor = ticker;
				label.appendChild(document.createTextNode(company));

				var br = document.createElement('br');

				var container = document.getElementById('checkboxContainer');
				container.appendChild(checkbox);
				container.appendChild(label);
				container.appendChild(br);

			});
	//		console.log(document.getElementById('checkboxContainer'));
//TODO: now stockShowList is stockList, exactly the same, need to remove duplicated var later.
			var stockShowList = stockList;
			stockShowList.forEach(function(stockId,index) {
				var ticker = stockId.Ticker;
				document.getElementById(ticker).onclick = function(){
					if (document.getElementById(ticker).checked)
					{
						stockShowList.push(stockId);
						console.log(ticker + " has been added to stock show list.");
					}
					else
					{
						var pos = stockShowList.indexOf(stockId);
						stockShowList.splice(pos,1);
						console.log(ticker + ' has been removed from stock show list');
					}

					//console.log(stockList);
				}
			});

			console.log(stockShowList);

		//	const plot = （stockList, svg）
			var timeMin = new Date('07/19/2010');
			var timeMax = new Date('07/17/2020');
			var priceMin = 0;
			var priceMax = 800000;
			var width = 1000;
			var height = 900;

            var xScale = d3.scaleTime().domain([timeMin, timeMax]).range([0, width]);
			var yScale = d3.scaleLinear().domain([priceMin, priceMax]).range([height, 0]);

            var xAxis = d3.axisBottom(xScale);
            var yAxis = d3.axisLeft(yScale);

            var svg = d3.select("svg");
            //d3.select("svg")
			svg.append("g")
			  .attr("transform", "translate(100, 50)")
			  .style("font", "14px times")
			  .call(yAxis);
			//d3.select("svg")
			svg.append("g")
			  .attr("transform", "translate(100, 950)")
			  .style("font", "14px times")
			  .call(xAxis);

            var colors = ['DarkOrange','SkyBlue','Crimson','LawnGreen', 'magenta', 'BlueViolet', 'BurlyWood', 'Brown', 'DarkGreen', 'DarkSlateGrey','IndianRed','LawnGreen','LightSalmon'];
			stockList.forEach(function(stockId, index){
				var ticker = stockId.Ticker;
				var company = stockId.Company;
				console.log(stockId);
				console.log(index);
				// if (stockId.localCompare('tsla') == 0) {

				// }

				const data = d3.csv('Data/' + ticker + '.csv')
				.then(function(data){
					// console.log(data);
					dates = data.map(function(d) {
						return new Date(d.Date); });

					closes = data.map(function(d) {
						return Number.parseFloat(d.Close); });

					console.log(dates[dates.length - 1]);
					console.log(closes[closes.length - 1]);
					var line = d3.line()
					             .x(function(d) {return xScale(new Date(d.Date));})
					             .y(function(d) {return yScale(parseFloat(d.Close)/parseFloat(closes[closes.length - 1])*10000); });

				//	d3.select('svg')
			  		svg.append('g')
			          .attr("transform", "translate(100, 50)")
			          .append("path")
			          .data([data])
			          .attr("d", line)
			          .attr("class", "line")
			          .attr("stroke", colors[index]);
				})
				.catch(function(){
					console.log("error loading file");

				});


			});

			var stockShowList = stockList;
			stockShowList.forEach(function(stockId,index) {
				var ticker = stockId.Ticker;
				document.getElementById(ticker).onclick = function(){
					if (document.getElementById(ticker).checked)
					{
						stockShowList.push(stockId);
						console.log(ticker + " has been added to stock show list.");
					}
					else
					{
						var pos = stockShowList.indexOf(stockId);
						stockShowList.splice(pos,1);
						console.log(ticker + ' has been removed from stock show list');
					}

/*					priceMax = 800000;

					yScale = d3.scaleLinear().domain([priceMin, priceMax]).range([height, 0]);
	
            		yAxis = d3.axisLeft(yScale);*/
            		//TODO: dynamically remove an svg element: http://www.java2s.com/Code/XML/SVG/DynamicallyRemovinganSVGElement.htm
					//console.log(stockList);
				}
			});

			console.log(stockShowList);

		}
	</script>
</body>
</html>
