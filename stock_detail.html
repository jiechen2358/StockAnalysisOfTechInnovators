<!DOCTYPE html>
<html>
<style>
.line {
	fill: none;
	stroke-width: 2px;
	stroke: #008B00;
}
circle {
	stroke: blue;
	r: 15;
}
</style>
<script src='https://d3js.org/d3.v5.min.js'></script>
<head>
	<title id='pageTitle'></title>
</head>
<body onload = 'init()'>
	<h1 id='heading1'></h1>
	<div class = 'overview' style="text-align: center;">
		<h1 id='overviewHeading'></h1>
		<svg width=1600 height=1000>
		</svg>
	</div>
	<div class = 'revenue' style="text-align: center;">
		<h1 id='revenueHeading'></h1>
		<svg width=1600 height=1000>
		</svg>
	</div>

	<div class = 'peg' style="text-align: center;">
		<h1 id='pegHeading'></h1>
		<svg width=1600 height=1000>
		</svg>
	</div>
	<div class = 'eps' style="text-align: center;">
		<h1 id='epsHeading'></h1>
		<svg width=1200 height=800>
		</svg>
	</div>

	<script>
		var margin = {
			top: 100,
			bottom: 100,
			left: 100,
			right: 100
		};
		var width = d3.select('.overview').select('svg').attr('width') - margin.left - margin.right;
		var height = d3.select('.overview').select('svg').attr('height') - margin.top - margin.bottom;

		var colors = ['Red', 'Green'];

		function getQueryVariable(variable)
		{
			var query = window.location.search.substring(1);
			var vars = query.split('&');
			for (var i=0;i<vars.length;i++) {
				var pair = vars[i].split('=');
				if (pair[0] == variable)
				{
					return pair[1];
				}
			}
		}

		async function init() {
			if (window.location.href.includes('?')) {
				stock = getQueryVariable('stock');
			}
			else {
				stock = 'FB';
			}
			const financialData = await d3.csv("Data/" + stock + '_Financials.csv');
			const priceData = await d3.csv('Data/' + stock +'_PRICES.csv');
			document.getElementById("pageTitle").innerHTML = stock + " Details";
			document.getElementById('overviewHeading').innerHTML = stock + ' Overview';
			document.getElementById('revenueHeading').innerHTML = stock + ' Revenue';
			document.getElementById('pegHeading').innerHTML = stock + ' PEG';

			dates =priceData.map(function(d){return new Date(d.Date);});
			revenues = financialData.map(function(d){return parseFloat(d.Revenue);});
			pegs = financialData.map(function(d){return parseFloat(d.PEG);});
			prices = priceData.map(function(d){return parseFloat(d.Close);});


			var colors = ['Green','Pink', 'DarkBlue'];
			var timeMin = Math.min(new Date(financialData[0].Date), new Date(financialData[financialData.length-1].Date));
			var timeMax = Math.max(new Date(financialData[0].Date), new Date(financialData[financialData.length-1].Date));
	
//revenue
			var xScaleRevenue = d3.scaleTime().domain([timeMin, timeMax]).range([0, width]);
			var xAxisRevenue = d3.axisBottom(xScaleRevenue);

			var revenueMin = Math.min.apply(null, revenues);
			var revenueMax = Math.max.apply(null, revenues);
			if (revenueMin >= 0)
			{
				revenueMin = 0;
			}

			var yScaleRevenue = d3.scaleLinear().domain([revenueMin, revenueMax]).range([height, 0]);
			var yAxisRevenue = d3.axisLeft(yScaleRevenue);


			d3.select('.revenue').select('svg').append("g")
					.attr("class", 'xAxis')
		   			.attr("transform", "translate("+ margin.left +", " + (margin.top + 800) +")")
	  	   			.style("font", "14px times")
	  	   			.call(xAxisRevenue);


			d3.select('.revenue').select('svg').append("g")
					.attr('class', 'yAxis')
	  	   			.attr("transform", "translate("+ margin.left + ", "+ margin.top + ")")
	  	   			.style("font", "14px times")
		   			.call(yAxisRevenue);

			d3.select('.revenue').select('svg').append("g")
			.attr('transform', 'translate(100, 100)')
			.selectAll('rect').data(financialData).enter().append('rect')
			.attr('width', 10)
			.attr('height', function(d){return 800- yScaleRevenue(parseFloat(d.Revenue));})
			.attr("x", function(d,i) {return xScaleRevenue(new Date(d.Date)) -10;})
			.attr('y', function(d){return yScaleRevenue(parseFloat(d.Revenue));})
			.attr('fill', colors[0]);


//PEG
			var xScalePEG  = d3.scaleTime().domain([timeMin, timeMax]).range([0, width]);

			var pegMin = Math.min.apply(null, pegs);
			var pegMax = Math.max.apply(null, pegs);
			if (pegMin >= 0)
			{
				pegMin = 0;
			}

			var yScalePEG = d3.scaleLinear().domain([pegMin, pegMax]).range([height, 0]);
			var xAxisPEG = d3.axisBottom(xScalePEG);

			d3.select('.peg').select('svg').append("g")
				.attr("class", 'xAxis')
	   			.attr("transform", "translate("+ margin.left +", " + (margin.top + yScalePEG(0)) +")")
  	   			.style("font", "14px times")
  	   			.call(xAxisPEG);

  	   		var yAxisPEG = d3.axisLeft(yScalePEG);

			d3.select('.peg').select('svg').append("g")
				.attr('class', 'yAxis')
  	   			.attr("transform", "translate("+ margin.left + ", "+ margin.top + ")")
  	   			.style("font", "14px times")
	   			.call(yAxisPEG);

			d3.select('.peg').select('svg').append('g')
            .attr("transform", "translate("+margin.left+", "+margin.top+")")
			.selectAll('rect').data(financialData).enter().append('rect')
			.attr('width', 10)
			.attr('height', function(d){return Math.abs(yScalePEG(parseFloat(d.PEG)) - yScalePEG(0));})
			.attr("x", function(d,i) {return xScalePEG(new Date(d.Date)) -10;})
			.attr('y', function(d){return Math.min(yScalePEG(parseFloat(d.PEG)), yScalePEG(0));})
			.attr('fill', colors[1]);
//OverView
			var timeMinOverview = Math.min.apply(null, dates);
			var timeMaxOverview = Math.max.apply(null, dates);
			var xScaleOverview = d3.scaleTime().domain([timeMinOverview, timeMaxOverview]).range([0, width]);

			var priceMin = 0;
			var priceMax = Math.max.apply(null, prices);
			var yScaleOverview = d3.scaleLinear().domain([priceMin, priceMax]).range([height, 0]);
			var xAxisOverview = d3.axisBottom(xScaleOverview);

			d3.select('.overview').select('svg').append("g")
				.attr("class", 'xAxis')
	   			.attr("transform", "translate("+ margin.left +", " + (margin.top + height) +")")
  	   			.style("font", "14px times")
  	   			.call(xAxisOverview);

  	   		var yAxisOverview = d3.axisLeft(yScaleOverview);

			d3.select('.overview').select('svg').append("g")
				.attr('class', 'yAxis')
  	   			.attr("transform", "translate("+ margin.left + ", "+ margin.top + ")")
  	   			.style("font", "14px times")
	   			.call(yAxisOverview);
			var line = d3.line()
        	 .x(function(d) {return xScaleOverview(new Date(d.Date));})
        	 .y(function(d) {return yScaleOverview(parseFloat(d.Close)); });

  			var stockline=d3.select('.overview').select('svg').append('g')
            .attr("transform", "translate("+margin.left+", "+margin.top+")")
         	.append("path")
         	.data([priceData])
         	.attr("d", line)
         	.attr('id', 'stockLine')
       		.attr("class", "line");

//section: eps
			document.getElementById('epsHeading').innerHTML = stock + ' Earnings Per Share';

			var timeMaxEPS = new Date(financialData[0].Date);
			var timeMinEPS = new Date(financialData[3].Date);

			var xScaleEPS = d3.scaleTime().domain([timeMinEPS, timeMaxEPS]).range([0, 1000]);
			var xAxisEPS = d3.axisBottom(xScaleEPS);

			var EPS = [];
			var ConsensusEPS=[];

			for (int i = 0; i < 4; i++)
			{
				EPS.push(financialData[i].EPS);
				ConsensusEPS.push(financialData[i].ConsensusEPS);
			}


			var epsMin = Math.min(Math.min.apply(null, EPS), Math.min.apply(null, ConsensusEPS));
			var epsMax = Math.max(Math.max.apply(null, EPS), Math.max.apply(null, ConsensusEPS));

			var yScaleEPS = d3.scaleLinear().domain([epsMin, epsMax]).range([600, 0]);
			var yAxisEPS = d3.axisLeft(yScaleEPS);

			d3.select('.eps').select('svg').append("g")
					.attr("class", 'xAxis')
		   			.attr("transform", "translate("+ margin.left +", " + (margin.top + 600) +")")
	  	   			.style("font", "14px times")
	  	   			.call(xAxis);


			d3.select('.eps').select('svg').append("g")
					.attr('class', 'yAxis')
	  	   			.attr("transform", "translate("+ margin.left + ", "+ margin.top + ")")
	  	   			.style("font", "14px times")
		   			.call(yAxis);

			d3.select('.eps').select('svg').append('g').attr('transform', 'translate(100, 100)')
			.selectAll('circle').data(financialData).enter().append('circle')
			.attr("cx", function(d,i) {return xScale(new Date(d.Date));})
			.attr('cy', function(d){return yScale(parseFloat(d.EPS));})
			.attr('fill', function(d,i){return colors[d.BEAT];});

			d3.select('.eps').select('svg').append('g').attr('transform', 'translate(100, 100)')
			.selectAll('circle').data(financialData).enter().append('circle')
			.attr("cx", function(d,i) {return xScale(new Date(d.Date));})
			.attr('cy', function(d){return yScale(parseFloat(d.ConsensusEPS));})
			.attr('fill', 'none');
		}
	</script>
</body>
</html>